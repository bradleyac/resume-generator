@using BlazorBootstrap
@using R3
@using RGS.Backend.Shared.ViewModels
@using System.Configuration
@using RGS.Frontend.ViewModels

@implements IDisposable

<div class="d-flex flex-column gap-4">
  <FormField @bind-Value="@(ViewModel.Label.Value)" class="col-6" Label=@("Skill Category") />
  <div class="d-flex flex-wrap gap-3 ms-3">
    @foreach (var (item, index) in @ViewModel.Items.Value.WithIndex())
    {
      <Badge @key="@index" Color="BadgeColor.Success" Position="Position.Relative">@item<Badge style="aspect-ratio: 1 / 1; display: flex; place-items: center" IndicatorType="BadgeIndicatorType.RoundedCircle" Color="BadgeColor.Danger" Position="Position.Absolute" Placement="BadgePlacement.TopLeft" @onclick="() => RemoveSkillAt(index)">
          <Icon Name="IconName.XLg" />
        </Badge>
      </Badge>
    }
  </div>
  <div class="d-flex gap-2 place-items-center">
    <label for="@newSkillId" class="collapse">Add Skill</label>
    <input id="@newSkillId" type="text" class="col-6" @bind-value="@NewSkill" @bind-value:event="oninput" />
    <Button Type="ButtonType.Button" Color="ButtonColor.Primary" disabled="@(NewSkill is null or "")" @onclick="@AddSkill">Add Skill</Button>
  </div>
</div>

@code {
  [Parameter] public required SkillCategory Category { get; set; }
  [Parameter] public required EventCallback<SkillCategory> CategoryChanged { get; set; }
  private SkillListViewModel ViewModel { get; set; } = default!;
  private string NewSkill { get; set; } = "";
  private string newSkillId = Guid.NewGuid().ToString();
  private CompositeDisposable _subscription = new();
  private bool _disposedValue;

  private async Task AddSkill()
  {
    ViewModel.Items.Value = [.. ViewModel.Items.Value, NewSkill];
    NewSkill = "";
  }

  private async Task RemoveSkillAt(int index)
  {
    ViewModel.Items.Value = [.. ViewModel.Items.Value[..index], .. ViewModel.Items.Value[(index + 1)..]];
  }

  protected override void OnInitialized()
  {
    ViewModel = new(Category);
    ViewModel.Category.DistinctUntilChanged().WhereNotNull().SubscribeAwait(async (cat, token) => await CategoryChanged.InvokeAsync(cat)).AddTo(_subscription);
  }

  public void Dispose()
  {
    if (!_disposedValue)
    {
      ViewModel?.Dispose();
    }

    _disposedValue = true;
  }
}